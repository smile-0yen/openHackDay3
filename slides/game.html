<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/epoch.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/epoch.min.css">
    <style>
      .gauges .epoch {
        display: inline-block;
      }
      #message1 {
        float: left;
        width: 50%;
      }
      #message2 {
        float: right;
        width: 50%;
      }
      .main {  
        width: 100%;  
        margin: 100 auto;  
      }  
      .main div   {  
        width: 80%;  
        margin: 0 auto;  
      }  
    </style>
  </head>
  <body>
    <div class="main">
    <embed src="sounds/battle.mp3" autostart="true" loop="true" height="0" width="0"></embed>

    <audio id="sound-file1" preload="auto">
      <source src="sounds/kick2.mp3" type="audio/mp3">
    </audio>
    <audio id="sound-file1-double" preload="auto">
      <source src="sounds/final_attack.mp3" type="audio/mp3">
    </audio>
    <audio id="sound-file2" preload="auto">
      <source src="sounds/middle_punch2.mp3" type="audio/mp3">
    </audio>
    <audio id="sound-file2-double" preload="auto">
      <source src="sounds/laser_beam.mp3" type="audio/mp3">
    </audio>

    <div id="area" class="epoch category10" style="height: 200px;"></div>
    <div class="gauges">
      <div id="gaugeChart"  class="epoch gauge-large" style="position: relative;"></div>
      <img id="ninjaBlue" src="images/ninja_blue.png" height="200"/>
      <img id="ninjaOrange" src="images/ninja_orange.png" height="200" />
      <div id="gaugeChart2" class="epoch gauge-large" style="position: relative;"></div>
    </div>
    <div id="message">
      <h1 id="message1" align="center" style="position: relative;"></h1>
      <h1 id="message2" align="center" style="position: relative;"></h1>
    </div>
    <div>
      <small><font color="gray">画像: Vectorartbox / 音楽: 魔王魂</font></small>
    </div>
    <div id="footer" width="900" height="50">
    </div>

    <script>
      var score1 = 0;
      var score2 = 0;

      var updateRate = 100;

      var player1 = 0;
      var player2 = 0;
      var player1_waza = "none";
      var player2_waza = "none";
      var player1_double = "none";
      var player2_double = "none";
      function updateData() {
        var request=new XMLHttpRequest();
        request.open("GET", './input', false);
        request.send("");
        var data = request.response.split(',');
        if (data && data.length >= 2) {
          player1 = data[0];
          score1 += parseFloat(player1);
          player2 = data[1];
          score2 += parseFloat(player2);
        }
        if (data && data.length >= 4) {
          player1_waza = data[2];
          player2_waza = data[3].replace(/\s+$/, "");
          //console.dir("p1:"+player1_waza+":");
          //console.dir("p2:"+player2_waza+":");
          if (player1_waza == "double") {
            player1_double = "double";
          }
          if (player2_waza == "double") {
            player2_double = "double";
          }
        } else {
          player1_waza = "none";
          player2_waza = "none";
        }
        setTimeout(function() { updateData(); },updateRate);
      }
      updateData();
            
      <!-- line graph  -->
      idx = ((new Date()).getTime()/1000)|0;
      var data = [
        { label: 'Layer 1', values: [ {time: idx, y: 0}] },
        { label: 'Layer 2', values: [ {time: idx, y: 0}] }
      ];

      var areaChartInstance = $('#area').epoch({
        type: 'time.line',
        data: data,
        axes: ['left', 'right', 'bottom']
      });

      var idx = 3;
      var nextData;

      function addData() {
        idx = ((new Date()).getTime()/1000)|0;
        nextData = [
          {time: idx, y: player1},{time: idx, y: player2}
        ];
        areaChartInstance.push(nextData);    
            
        setTimeout(function() { addData(); },updateRate/2);
      }
      addData();

      <!-- left hand side gauge  -->
      var value1 = 0;
      gaugeChartInstance = $('#gaugeChart').epoch({
        type: 'time.gauge',
        value: 1,
        format: function(v) { value1=v; return 'HP:' + (v*100).toFixed(2); }
      });

      <!-- right hand side gauge  -->
      var value2 = 0;
      gaugeChartInstance2 = $('#gaugeChart2').epoch({
        type: 'time.gauge',
        value: 1,
        format: function(v) { value2=v; return 'HP:' + (v*100).toFixed(2); }
      });

      var hp1 = 1;
      var hp2 = 1;

      var attach_threashold = 30;
      //var attach_threashold = 100;

      function addValue() {
        if (player1_motion == true) {
          setTimeout(function() { addValue(); }, updateRate);
          return;
        }
        var ninja1 = document.getElementById('ninjaBlue');
        var message1 = document.getElementById('message1');
        if (player1_double == "double" &&
            player1_waza == "attack" && score1 > attach_threashold) {
          setTimeout(function(){bluesp1();}, updateRate);
          hp2 = hp2 - (score1*2 / 1000);
          gaugeChartInstance2.push(hp2);
          score1 = 0;
          player1_double = "none";
          if (hp2 < 0) {
            setTimeout(function(){bluewin();}, 2000);
          }
        } else if (player1_waza == "attack" && score1 > attach_threashold) {
          ninja1.src="images/ninja_blue_kick.png";
          hp2 = hp2 - (score1 / 1000);
          gaugeChartInstance2.push(hp2);
          score1 = 0;
          document.getElementById("sound-file1").play();
          if (hp2 < 0) {
            setTimeout(function(){bluewin();}, 2000);
          }
        } else {
          ninja1.src="images/ninja_blue.png";
          if (player1_double == "double") {
            message1.textContent = "Power: "+ (score1/10).toFixed(2) + " * 2";
          } else {
            message1.textContent = "Power: "+ (score1/10).toFixed(2);
          }
        }
        if (10 > score1/10) {
          message1.style.color = "black";
        } else if (10 < score1/10) {
          message1.style.color = "red";
        }
        setTimeout(function() { addValue(); }, updateRate);
      }
      addValue();

      function addValue2() {
        if (player2_motion == true) {
          setTimeout(function() { addValue2(); }, updateRate);
          return;
        }
        var ninja2 = document.getElementById('ninjaOrange');
        var message2 = document.getElementById('message2');
        if (player2_double == "double" &&
            player2_waza == "attack" && score2 > attach_threashold) {
          setTimeout(function(){orangesp1();}, updateRate);
          hp1 = hp1 - (score2*2 / 1000);
          gaugeChartInstance.push(hp1);
          score2 = 0;
          player2_double = "none";
          if (hp1 < 0) {
            setTimeout(function(){orangewin();}, 2000);
          }
        } else if (player2_waza == "attack" && score2 > attach_threashold) {
          ninja2.src="images/ninja_orange_kick.png";
          hp1 = hp1 - (score2 / 1000);
          gaugeChartInstance.push(hp1);
          score2 = 0;
          document.getElementById("sound-file2").play();
          if (hp1 < 0) {
            setTimeout(function(){orangewin();}, 2000);
          }
        } else {
          ninja2.src="images/ninja_orange.png";
          if (player2_double == "double") {
            message2.textContent = "Power: " + (score2/10).toFixed(2) + " * 2";
          } else {
            message2.textContent = "Power: " + (score2/10).toFixed(2);
          }
        }
        if (10 > score2/10) {
          message2.style.color = "black";
        } else if (10 < score2/10) {
          message2.style.color = "red";
        }
        setTimeout(function() { addValue2(); }, updateRate);
      }
      addValue2();

      function bluewin() {
        location.href="bluewin.html";
      }
      function orangewin() {
        location.href="orangewin.html";
      }

      var player1_motion = false;
      var player2_motion = false;
      function bluesp1() {
        player1_motion = true;
        setTimeout(function(){bluesp2();}, updateRate*3);
        var ninja1 = document.getElementById('ninjaBlue');
        ninja1.src="images/blue_sp01.png";
        document.getElementById("sound-file1").play();
      }
      function bluesp2() {
        setTimeout(function(){bluesp3();}, updateRate*3);
        var ninja1 = document.getElementById('ninjaBlue');
        ninja1.src="images/blue_sp02.png";
        document.getElementById("sound-file1").play();
      }
      function bluesp3() {
        setTimeout(function(){bluesleep();}, updateRate*3);
        var ninja1 = document.getElementById('ninjaBlue');
        ninja1.src="images/blue_sp03.png";
        document.getElementById("sound-file1").play();
      }
      function bluesleep() {
        player1_motion = false;
      }
      function orangesp1() {
        player2_motion = true;
        setTimeout(function(){orangesp2();}, updateRate*3);
        var ninja2 = document.getElementById('ninjaOrange');
        ninja2.src="images/orange_sp01.png";
        document.getElementById("sound-file2").play();
      }
      function orangesp2() {
        setTimeout(function(){orangesp3();}, updateRate*3);
        var ninja2 = document.getElementById('ninjaOrange');
        ninja2.src="images/orange_sp02.png";
        document.getElementById("sound-file2").play();
      }
      function orangesp3() {
        setTimeout(function(){orangesleep();}, updateRate*3);
        var ninja2 = document.getElementById('ninjaOrange');
        ninja2.src="images/orange_sp03.png";
        document.getElementById("sound-file2").play();
      }
      function orangesleep() {
        player2_motion = false;
      }
    </script>
  </div>
  </body>
</html>
